<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Dashboard - MindSpace</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .dashboard-wrapper { min-height: 100vh; background: #F5F9F8; padding-top: 80px; }
        .dashboard-container { max-width: 1200px; margin: 0 auto; padding: 30px 20px; }
        .dashboard-header { background: #FFF; border: 1px solid #E5E7EB; border-radius: 16px; padding: 30px; margin-bottom: 30px; }
        .welcome-title { font-size: 32px; color: #2C3E50; margin: 0 0 10px 0; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: #FFF; border: 1px solid #E5E7EB; border-radius: 12px; padding: 20px; text-align: center; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; }
        .stat-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .stat-card.active { border: 2px solid #5A9B8E; box-shadow: 0 4px 12px rgba(90,155,142,0.2); }
        .stat-number { font-size: 36px; font-weight: 800; color: #5A9B8E; display: block; }
        .stat-label { font-size: 12px; color: #6B7280; text-transform: uppercase; margin-top: 8px; display: block; }
        .dashboard-section { background: #FFF; border: 1px solid #E5E7EB; border-radius: 16px; padding: 30px; margin-bottom: 30px; }
        .section-title { font-size: 24px; color: #2C3E50; margin: 0 0 20px 0; }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px; }
        .btn-primary { padding: 12px 24px; background: linear-gradient(135deg, #5A9B8E 0%, #4A8B7E 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; text-decoration: none; display: inline-block; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(90,155,142,0.3); }
        .filter-bar { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; width: 100%; }
        .search-box { flex: 1; min-width: 250px; position: relative; }
        .search-input { width: 100%; padding: 12px 12px 12px 40px; border: 1px solid #E5E7EB; border-radius: 8px; font-size: 14px; }
        .search-icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #6B7280; }
        .filter-select { padding: 12px 15px; border: 1px solid #E5E7EB; border-radius: 8px; font-size: 14px; background: white; cursor: pointer; min-width: 150px; }
        .appointments-list { display: flex; flex-direction: column; gap: 16px; }
        .appointment-card { background: #F5F9F8; border: 1px solid #E5E7EB; border-radius: 12px; padding: 20px; }
        .therapist-name { font-size: 18px; font-weight: 700; color: #2C3E50; margin: 0 0 4px 0; }
        .therapist-spec { font-size: 14px; color: #6B7280; margin: 0 0 8px 0; }
        .status-badge { display: inline-block; padding: 6px 14px; border-radius: 20px; font-size: 12px; font-weight: 700; text-transform: uppercase; }
        .status-pending { background: #FFF3CD; color: #856404; }
        .status-confirmed { background: #D4EDDA; color: #155724; }
        .status-completed { background: #D1ECF1; color: #0C5460; }
        .status-cancelled { background: #F8D7DA; color: #721C24; }
        .status-rejected { background: #F8D7DA; color: #721C24; }
        .btn-cancel { padding: 10px 20px; background: #f44336; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; margin-right: 10px; }
        .btn-cancel:hover { background: #d32f2f; }
        .loading, .empty-state { text-align: center; padding: 40px; color: #6B7280; }
        .modal { display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
        .modal.active { display: flex; align-items: center; justify-content: center; }
        .modal-content { background: white; border-radius: 16px; padding: 40px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .modal-title { font-size: 24px; font-weight: 700; color: #2C3E50; margin: 0; }
        .btn-close { background: none; border: none; font-size: 24px; cursor: pointer; color: #6B7280; padding: 0; width: 32px; height: 32px; }
        .btn-close:hover { color: #2C3E50; }
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; margin-bottom: 8px; color: #2C3E50; font-weight: 600; font-size: 14px; }
        .form-input, .form-textarea, .form-select { padding: 12px; border: 1px solid #E5E7EB; border-radius: 8px; width: 100%; font-family: inherit; font-size: 14px; }
        .form-textarea { resize: vertical; min-height: 100px; }
        .btn-secondary { padding: 12px 24px; background: #E5E7EB; color: #4B5563; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px; margin-right: 10px; }
        .btn-secondary:hover { background: #D1D5DB; }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar">
        <div class="nav-container">
            <a href="index.html" class="logo">
                <span class="logo-icon">üß†</span>
                <span class="logo-text">MindSpace</span>
            </a>
            <ul class="nav-links">
                <li><a href="user-dashboard.html" class="active">Dashboard</a></li>
                <li><a href="find-therapist.html">Find Therapist</a></li>
                <li><a href="#" onclick="openProfileModal()">Profile</a></li>
                <li><a href="#" onclick="logout()" class="btn-logout">Logout</a></li>
            </ul>
        </div>
    </nav>

    <div class="dashboard-wrapper">
        <div class="dashboard-container">
            <!-- Dashboard Header -->
            <div class="dashboard-header">
                <h1 class="welcome-title" id="welcomeMessage">Welcome back, User!</h1>
                <p style="color: #6B7280; font-size: 14px;">Manage your therapy sessions and track your progress</p>
            </div>

            <!-- Statistics Cards -->
            <div class="stats-grid">
                <div class="stat-card" onclick="filterByStatus('all')">
                    <span class="stat-number" id="totalBookings">0</span>
                    <span class="stat-label">Total Sessions</span>
                </div>
                <div class="stat-card" onclick="filterByStatus('pending')">
                    <span class="stat-number" id="pendingBookings">0</span>
                    <span class="stat-label">Pending</span>
                </div>
                <div class="stat-card" onclick="filterByStatus('confirmed')">
                    <span class="stat-number" id="confirmedBookings">0</span>
                    <span class="stat-label">Upcoming</span>
                </div>
                <div class="stat-card" onclick="filterByStatus('completed')">
                    <span class="stat-number" id="completedBookings">0</span>
                    <span class="stat-label">Completed</span>
                </div>
            </div>

            <!-- My Sessions Section -->
            <div class="dashboard-section">
                <div class="section-header">
                    <h2 class="section-title">My Sessions</h2>
                    <a href="find-therapist.html" class="btn-primary">
                        <i class="fas fa-plus"></i> Book New Session
                    </a>
                </div>
                
                <!-- Filter Bar -->
                <div class="filter-bar">
                    <div class="search-box">
                        <i class="fas fa-search search-icon"></i>
                        <input type="text" id="searchInput" class="search-input" placeholder="Search by therapist name..." onkeyup="searchSessions()">
                    </div>
                    <select id="statusFilter" class="filter-select" onchange="filterSessions()">
                        <option value="all">All Status</option>
                        <option value="pending">Pending</option>
                        <option value="confirmed">Confirmed</option>
                        <option value="completed">Completed</option>
                        <option value="cancelled">Cancelled</option>
                        <option value="rejected">Rejected</option>
                    </select>
                    <select id="dateFilter" class="filter-select" onchange="filterSessions()">
                        <option value="all">All Dates</option>
                        <option value="upcoming">Upcoming</option>
                        <option value="past">Past</option>
                    </select>
                </div>

                <!-- Sessions List -->
                <div id="sessionsList" class="appointments-list">
                    <div class="loading">Loading sessions...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Profile Modal -->
    <div id="profileModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Edit Profile</h2>
                <button class="btn-close" onclick="closeProfileModal()">&times;</button>
            </div>
            <form onsubmit="saveProfile(event)">
                <div class="form-group">
                    <label class="form-label">Full Name</label>
                    <input type="text" id="profileFullName" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" id="profileEmail" class="form-input" disabled>
                </div>
                <div class="form-group">
                    <label class="form-label">Phone</label>
                    <input type="tel" id="profilePhone" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Date of Birth</label>
                    <input type="date" id="profileDOB" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Gender</label>
                    <select id="profileGender" class="form-select">
                        <option value="">Select Gender</option>
                        <option value="Male">Male</option>
                        <option value="Female">Female</option>
                        <option value="Other">Other</option>
                        <option value="Prefer not to say">Prefer not to say</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">City</label>
                    <input type="text" id="profileCity" class="form-input">
                </div>
                <div class="form-group">
                    <label class="form-label">Address</label>
                    <textarea id="profileAddress" class="form-textarea" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Emergency Contact Name</label>
                    <input type="text" id="profileEmergencyName" class="form-input">
                </div>
                <div class="form-group">
                    <label class="form-label">Emergency Contact Phone</label>
                    <input type="tel" id="profileEmergencyPhone" class="form-input">
                </div>
                <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 25px;">
                    <button type="button" class="btn-secondary" onclick="closeProfileModal()">Cancel</button>
                    <button type="submit" class="btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Load Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="app.js"></script>
    
    <script>
// ===== FIXED USER DASHBOARD - ALL FEATURES INTACT =====
const supabaseClient = window.supabaseClient;
let currentUser = null;
let currentProfile = null;
let allSessions = [];
let therapistMap = {};

// ‚úÖ CRITICAL FIX: Initialize with proper auth
document.addEventListener('DOMContentLoaded', async function() {
    console.log('üîµ Initializing user dashboard...');
    
    try {
        // ‚úÖ FIX: Get user from Supabase Auth instead of localStorage
        const { data: { user: authUser }, error: authError } = await supabaseClient.auth.getUser();
        
        if (authError || !authUser) {
            console.error('‚ùå Auth error:', authError);
            alert('Session expired. Please login again.');
            window.location.href = 'login.html';
            return;
        }
        
        console.log('‚úÖ Logged in user:', authUser.id, authUser.email);
        
        // Set current user with correct ID from auth
        currentUser = {
            id: authUser.id,
            email: authUser.email,
            role: 'user'
        };
        
        await loadProfileData();
        await loadSessions();
        
        console.log('‚úÖ Dashboard initialized successfully');
        
    } catch (error) {
        console.error('‚ùå Error initializing dashboard:', error);
        alert('Error loading dashboard. Please try again.');
        window.location.href = 'login.html';
    }
});

// Load profile data
async function loadProfileData() {
    console.log('üîµ Loading profile for user:', currentUser.id);
    try {
        const { data, error } = await supabaseClient
            .from('profiles')
            .select('*')
            .eq('user_id', currentUser.id)
            .single();
        
        if (error) throw error;
        
        console.log('‚úÖ Profile loaded:', data);
        currentProfile = data;
        
        // Update welcome message
        const welcomeMsg = document.getElementById('welcomeMessage');
        if (welcomeMsg && data) {
            welcomeMsg.textContent = `Welcome back, ${data.full_name || 'User'}!`;
        }
        
    } catch (error) {
        console.error('‚ùå Error loading profile:', error);
    }
}

// Load sessions
async function loadSessions() {
    console.log('üîµ Loading sessions for user:', currentUser.id);
    try {
        const { data: bookings, error } = await supabaseClient
            .from('Bookings')
            .select('*')
            .eq('user_id', currentUser.id)
            .order('session_date', { ascending: false });
        
        if (error) throw error;
        
        console.log('‚úÖ Sessions loaded:', bookings);
        allSessions = bookings || [];
        
        // Load therapist data for all bookings
        const therapistIds = [...new Set(bookings.map(b => b.therapist_id))];
        for (const therapistId of therapistIds) {
            if (!therapistMap[therapistId]) {
                const { data: therapistData } = await supabaseClient
                    .from('Therapists')
                    .select('Name, Specialization, phone, email')
                    .eq('id', therapistId)
                    .single();
                if (therapistData) {
                    therapistMap[therapistId] = therapistData;
                }
            }
        }
        
        updateStatistics();
        displaySessions(allSessions);
        
    } catch (error) {
        console.error('‚ùå Error loading sessions:', error);
        const sessionsList = document.getElementById('sessionsList');
        if (sessionsList) {
            sessionsList.innerHTML = '<div class="empty-state">‚ùå Error loading sessions</div>';
        }
    }
}

// Update statistics
function updateStatistics() {
    const total = allSessions.length;
    const pending = allSessions.filter(s => s.status === 'pending').length;
    const confirmed = allSessions.filter(s => s.status === 'confirmed').length;
    const completed = allSessions.filter(s => s.status === 'completed').length;
    
    document.getElementById('totalBookings').textContent = total;
    document.getElementById('pendingBookings').textContent = pending;
    document.getElementById('confirmedBookings').textContent = confirmed;
    document.getElementById('completedBookings').textContent = completed;
}

// Display sessions
function displaySessions(sessions) {
    const sessionsList = document.getElementById('sessionsList');
    
    if (!sessions || sessions.length === 0) {
        sessionsList.innerHTML = '<div class="empty-state">üìÖ No sessions found. Book your first session!</div>';
        return;
    }
    
    sessionsList.innerHTML = '';
    
    sessions.forEach(session => {
        const therapist = therapistMap[session.therapist_id] || { Name: 'Unknown', Specialization: '' };
        const card = createSessionCard(session, therapist);
        sessionsList.innerHTML += card;
    });
}

// Create session card HTML
function createSessionCard(session, therapist) {
    const date = new Date(session.session_date).toLocaleDateString('en-IN', { 
        day: 'numeric', 
        month: 'short', 
        year: 'numeric' 
    });
    
    let actions = '';
    if (session.status === 'pending' || session.status === 'confirmed') {
        actions = `<button class="btn-cancel" onclick="cancelSession('${session.id}')">Cancel Session</button>`;
    }
    
    return `
        <div class="appointment-card">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                <div>
                    <h3 class="therapist-name">Dr. ${therapist.Name}</h3>
                    <p class="therapist-spec">${therapist.Specialization}</p>
                </div>
                <span class="status-badge status-${session.status}">${session.status}</span>
            </div>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 15px;">
                <div><strong>üìÖ Date:</strong> ${date}</div>
                <div><strong>‚è∞ Time:</strong> ${session.session_time || 'TBD'}</div>
            </div>
            ${session.problem_description ? `<div style="margin-bottom: 15px; padding: 10px; background: #FFF7ED; border-radius: 8px;"><strong>Your Concern:</strong> ${session.problem_description}</div>` : ''}
            ${session.session_notes ? `<div style="margin-bottom: 15px; padding: 10px; background: #E0F2FE; border-radius: 8px;"><strong>Session Notes:</strong> ${session.session_notes}</div>` : ''}
            ${session.therapist_reschedule_reason ? `<div style="margin-bottom: 15px; padding: 10px; background: #FEF3C7; border-radius: 8px;"><strong>‚ö†Ô∏è Therapist Note:</strong> ${session.therapist_reschedule_reason}</div>` : ''}
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                ${actions}
            </div>
        </div>
    `;
}

// Filter sessions by status
function filterByStatus(status) {
    document.getElementById('statusFilter').value = status;
    
    // Update active stat card
    document.querySelectorAll('.stat-card').forEach(card => card.classList.remove('active'));
    if (event && event.target) {
        event.target.closest('.stat-card').classList.add('active');
    }
    
    filterSessions();
}

// Filter sessions
function filterSessions() {
    const statusFilter = document.getElementById('statusFilter').value;
    const dateFilter = document.getElementById('dateFilter').value;
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    
    let filtered = allSessions;
    
    // Filter by status
    if (statusFilter !== 'all') {
        filtered = filtered.filter(s => s.status === statusFilter);
    }
    
    // Filter by date
    if (dateFilter !== 'all') {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        filtered = filtered.filter(s => {
            const sessionDate = new Date(s.session_date);
            sessionDate.setHours(0, 0, 0, 0);
            
            if (dateFilter === 'upcoming') {
                return sessionDate >= today;
            } else if (dateFilter === 'past') {
                return sessionDate < today;
            }
            return true;
        });
    }
    
    // Filter by search term
    if (searchTerm) {
        filtered = filtered.filter(s => {
            const therapist = therapistMap[s.therapist_id] || {};
            return (therapist.Name || '').toLowerCase().includes(searchTerm) ||
                   (therapist.Specialization || '').toLowerCase().includes(searchTerm);
        });
    }
    
    displaySessions(filtered);
}

// Search sessions
function searchSessions() {
    filterSessions();
}

// Cancel session
async function cancelSession(sessionId) {
    if (!confirm('Are you sure you want to cancel this session?')) return;
    
    try {
        const { error } = await supabaseClient
            .from('Bookings')
            .update({ status: 'cancelled' })
            .eq('id', sessionId);
        
        if (error) throw error;
        
        alert('‚úÖ Session cancelled');
        await loadSessions();
    } catch (error) {
        console.error('Error:', error);
        alert('Error cancelling session');
    }
}

// Open profile modal
function openProfileModal() {
    if (!currentProfile) {
        alert('Profile data not loaded');
        return;
    }
    
    document.getElementById('profileFullName').value = currentProfile.full_name || '';
    document.getElementById('profileEmail').value = currentProfile.email || '';
    document.getElementById('profilePhone').value = currentProfile.phone || '';
    document.getElementById('profileDOB').value = currentProfile.date_of_birth || '';
    document.getElementById('profileGender').value = currentProfile.gender || '';
    document.getElementById('profileCity').value = currentProfile.city || '';
    document.getElementById('profileAddress').value = currentProfile.address || '';
    document.getElementById('profileEmergencyName').value = currentProfile.emergency_contact_name || '';
    document.getElementById('profileEmergencyPhone').value = currentProfile.emergency_contact_phone || '';
    
    // ‚úÖ FIX: Set max date for birthday to prevent future dates
    const today = new Date();
    document.getElementById('profileDOB').max = today.toISOString().split('T')[0];
    
    document.getElementById('profileModal').classList.add('active');
}

// Close profile modal
function closeProfileModal() {
    document.getElementById('profileModal').classList.remove('active');
}

// Save profile
async function saveProfile(event) {
    event.preventDefault();
    
    const updated = {
        full_name: document.getElementById('profileFullName').value.trim(),
        phone: document.getElementById('profilePhone').value.trim(),
        date_of_birth: document.getElementById('profileDOB').value,
        gender: document.getElementById('profileGender').value,
        city: document.getElementById('profileCity').value.trim(),
        address: document.getElementById('profileAddress').value.trim(),
        emergency_contact_name: document.getElementById('profileEmergencyName').value.trim(),
        emergency_contact_phone: document.getElementById('profileEmergencyPhone').value.trim()
    };
    
    try {
        const { error } = await supabaseClient
            .from('profiles')
            .update(updated)
            .eq('user_id', currentUser.id);
        
        if (error) throw error;
        
        alert('‚úÖ Profile updated!');
        closeProfileModal();
        await loadProfileData();
    } catch (error) {
        console.error('Error:', error);
        alert('Error updating profile');
    }
}

// Logout
async function logout() {
    try {
        await supabaseClient.auth.signOut();
        localStorage.clear();
        window.location.href = 'login.html';
    } catch (error) {
        window.location.href = 'login.html';
    }
}
    </script>
</body>
</html>
