
user-dashboard-updated.html
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>User Dashboard - MindSpace</title>
<link rel="stylesheet" href="style.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
.dashboard-wrapper { min-height: 100vh; background: #F5F9F8; padding-top: 80px; }
.dashboard-container { max-width: 1200px; margin: 0 auto; padding: 30px 20px; }
.dashboard-header { background: #FFF; border: 1px solid #E5E7EB; border-radius: 16px; padding: 30px; margin-bottom: 30px; }
.welcome-title { font-size: 32px; color: #2C3E50; margin: 0 0 10px 0; }
.therapists-section { margin-bottom: 40px; }
.section-title { font-size: 24px; color: #2C3E50; margin: 0 0 20px 0; display: flex; align-items: center; gap: 10px; }
.section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px; }
.filter-container { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
.filter-label { color: #6B7280; font-weight: 600; font-size: 14px; }
.filter-select { padding: 10px 15px; border: 1px solid #E5E7EB; border-radius: 8px; font-size: 14px; background: white; cursor: pointer; min-width: 180px; }
.therapists-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
.therapist-card { background: #FFF; border: 1px solid #E5E7EB; border-radius: 16px; padding: 25px; transition: transform 0.2s, box-shadow 0.2s; }
.therapist-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
.therapist-name { font-size: 22px; font-weight: 800; color: #2C3E50; margin: 0 0 8px 0; }
.therapist-specialty { color: #5A9B8E; font-size: 15px; font-weight: 600; margin-bottom: 15px; }
.therapist-fee { font-size: 20px; font-weight: 700; color: #2C3E50; margin-bottom: 10px; }
.therapist-bio { color: #6B7280; font-size: 14px; margin-bottom: 20px; line-height: 1.5; }
.booking-form { display: flex; flex-direction: column; gap: 12px; }
.form-input, .form-select, .form-textarea { width: 100%; padding: 12px; border: 1px solid #E5E7EB; border-radius: 8px; font-size: 14px; font-family: inherit; }
.form-textarea { resize: vertical; min-height: 80px; }
.btn-book { width: 100%; padding: 12px; background: #5A9B8E; color: white; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; transition: background 0.3s; }
.btn-book:hover { background: #4A8B7E; }
.btn-book:disabled { background: #9CA3AF; cursor: not-allowed; }
.bookings-section { background: #FFF; border: 1px solid #E5E7EB; border-radius: 16px; padding: 30px; }
.bookings-list { display: flex; flex-direction: column; gap: 15px; margin-top: 20px; }
.booking-card { background: #F5F9F8; border: 1px solid #E5E7EB; border-radius: 12px; padding: 20px; }
.status-badge { display: inline-block; padding: 6px 14px; border-radius: 20px; font-size: 12px; font-weight: 700; text-transform: uppercase; }
.status-pending { background: #FFF3CD; color: #856404; }
.status-confirmed { background: #D4EDDA; color: #155724; }
.status-completed { background: #D1ECF1; color: #0C5460; }
.status-rejected { background: #F8D7DA; color: #721C24; }
.status-cancelled { background: #6C757D; color: #FFF; }
.btn-join { padding: 10px 20px; background: #5A9B8E; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; text-decoration: none; display: inline-block; margin-right: 10px; }
.btn-join:hover { background: #4A8B7E; }
.btn-reschedule { padding: 10px 20px; background: #F59E0B; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; margin-right: 10px; }
.btn-reschedule:hover { background: #D97706; }
.btn-cancel { padding: 10px 20px; background: #EF4444; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; }
.btn-cancel:hover { background: #DC2626; }
.btn-accept { padding: 10px 20px; background: #10B981; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; margin-right: 10px; }
.btn-accept:hover { background: #059669; }
.loading, .empty-state { text-align: center; padding: 40px; color: #6B7280; }
.info-box { background: #E0F2F1; padding: 15px; border-radius: 8px; border-left: 4px solid #5A9B8E; margin-top: 15px; }
.info-box-title { font-weight: 700; color: #2C3E50; margin-bottom: 8px; font-size: 14px; }
.info-box-text { color: #4B5563; font-size: 13px; line-height: 1.5; }
.profile-incomplete-banner { background: #FEF3C7; border: 2px solid #F59E0B; border-radius: 12px; padding: 20px; margin-bottom: 20px; }
.profile-incomplete-banner h3 { color: #92400E; margin: 0 0 10px 0; font-size: 18px; }
.profile-incomplete-banner p { color: #78350F; margin: 0 0 15px 0; }
.profile-incomplete-banner button { background: #F59E0B; color: white; border: none; padding: 12px 24px; border-radius: 8px; font-weight: 700; cursor: pointer; }
.profile-incomplete-banner button:hover { background: #D97706; }
.modal { display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); overflow-y: auto; }
.modal.active { display: flex; align-items: center; justify-content: center; padding: 20px; }
.modal-content { background: white; border-radius: 16px; padding: 40px; max-width: 700px; width: 100%; max-height: 90vh; overflow-y: auto; }
.modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
.modal-title { font-size: 28px; font-weight: 700; color: #2C3E50; margin: 0; }
.close-modal { background: none; border: none; font-size: 28px; color: #6B7280; cursor: pointer; }
.close-modal:hover { color: #2C3E50; }
.profile-form, .reschedule-form { display: flex; flex-direction: column; gap: 20px; }
.form-group { display: flex; flex-direction: column; gap: 8px; }
.form-label { font-weight: 600; color: #2C3E50; font-size: 14px; }
.btn-save { padding: 14px; background: #5A9B8E; color: white; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; font-size: 16px; transition: background 0.3s; }
.btn-save:hover { background: #4A8B7E; }
.profile-picture-container { display: flex; flex-direction: column; align-items: center; gap: 15px; margin-bottom: 20px; }
.profile-picture-preview { width: 150px; height: 150px; border-radius: 50%; object-fit: cover; border: 4px solid #5A9B8E; }
.profile-picture-placeholder { width: 150px; height: 150px; border-radius: 50%; background: #E5E7EB; display: flex; align-items: center; justify-content: center; font-size: 60px; color: #6B7280; border: 4px solid #E5E7EB; }
.file-input-wrapper { position: relative; display: inline-block; }
.file-input-wrapper input[type=file] { display: none; }
.file-input-label { padding: 10px 20px; background: #5A9B8E; color: white; border-radius: 8px; cursor: pointer; font-weight: 600; display: inline-block; }
.file-input-label:hover { background: #4A8B7E; }
.action-buttons { display: flex; gap: 10px; margin-top: 15px; padding-top: 15px; border-top: 1px solid #E5E7EB; flex-wrap: wrap; }
.form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
.danger-zone { border-top: 2px solid #EF4444; padding-top: 20px; margin-top: 20px; }
.danger-zone h3 { color: #DC2626; font-size: 18px; margin-bottom: 10px; }
.danger-zone p { color: #6B7280; font-size: 14px; margin-bottom: 15px; line-height: 1.5; }
.btn-delete-account { background: #EF4444; color: white; border: none; padding: 12px 24px; border-radius: 8px; font-weight: 700; cursor: pointer; width: 100%; transition: background 0.3s; }
.btn-delete-account:hover { background: #DC2626; }
</style>
</head>
<body>
<div class="dashboard-wrapper">
<nav class="navbar">
<div class="nav-container">
<a href="index.html" class="logo"><span class="logo-icon">üß†</span><span class="logo-text">MindSpace</span></a>
<ul class="nav-links">
<li><a href="user-dashboard.html" class="active">Dashboard</a></li>
<li><a href="#" onclick="openProfileModal(); return false;">My Profile</a></li>
<li><button onclick="logout()" class="btn-primary">Logout</button></li>
</ul>
</div>
</nav>

<main class="dashboard-container">
<div class="dashboard-header">
<h1 class="welcome-title">Welcome Back!</h1>
<p id="userName" style="color: #6B7280;">Loading...</p>
</div>

<!-- Profile Incomplete Warning -->
<div id="profileIncompleteBanner" style="display: none;" class="profile-incomplete-banner">
<h3><i class="fas fa-exclamation-triangle"></i> Complete Your Profile</h3>
<p>Please complete your profile with mandatory information (Name, Phone, DOB, Gender, City) before booking sessions.</p>
<button onclick="openProfileModal()">
<i class="fas fa-user-edit"></i> Complete Profile Now
</button>
</div>

<section class="therapists-section">
<div class="section-header">
<h2 class="section-title"><i class="fas fa-user-md"></i> Find a Therapist</h2>
<div class="filter-container">
<span class="filter-label">Filter by:</span>
<select id="specializationFilter" class="filter-select" onchange="filterTherapists()">
<option value="all">All Specializations</option>
<option value="Clinical Psychology">Clinical Psychology</option>
<option value="Counseling Psychology">Counseling Psychology</option>
<option value="Child Psychology">Child Psychology</option>
<option value="Marriage & Family Therapy">Marriage & Family Therapy</option>
<option value="Cognitive Behavioral Therapy">Cognitive Behavioral Therapy</option>
<option value="Trauma Therapy">Trauma Therapy</option>
<option value="Addiction Counseling">Addiction Counseling</option>
<option value="Career Counseling">Career Counseling</option>
</select>
</div>
</div>
<div id="therapistsGrid" class="therapists-grid">
<div class="loading">Loading therapists...</div>
</div>
</section>

<section class="bookings-section">
<div class="section-header">
<h2 class="section-title"><i class="fas fa-calendar-check"></i> My Bookings</h2>
<div class="filter-container">
<span class="filter-label">Sort by Session Date:</span>
<select id="bookingSortFilter" class="filter-select" onchange="loadBookings()">
<option value="upcoming">Upcoming First</option>
<option value="recent">Most Recent First</option>
</select>
<span class="filter-label">Status:</span>
<select id="bookingStatusFilter" class="filter-select" onchange="loadBookings()">
<option value="all">All Bookings</option>
<option value="pending">Pending</option>
<option value="confirmed">Confirmed</option>
<option value="completed">Completed</option>
<option value="rejected">Rejected</option>
</select>
</div>
</div>
<div id="bookingsList" class="bookings-list">
<div class="loading">Loading bookings...</div>
</div>
</section>
</main>
</div>

<!-- Profile Modal -->
<div id="profileModal" class="modal">
<div class="modal-content">
<div class="modal-header">
<h2 class="modal-title">My Profile</h2>
<button class="close-modal" onclick="closeProfileModal()">&times;</button>
</div>
<form class="profile-form" onsubmit="saveProfile(event)">
<!-- Profile Picture Upload -->
<div class="profile-picture-container">
<div id="profilePicturePreview">
<div class="profile-picture-placeholder">
<i class="fas fa-user"></i>
</div>
</div>
<div class="file-input-wrapper">
<input type="file" id="profilePictureInput" accept="image/*" onchange="handleProfilePictureChange(event)">
<label for="profilePictureInput" class="file-input-label">
<i class="fas fa-camera"></i> Upload Photo
</label>
</div>
<div style="text-align: center; color: #6B7280; font-size: 12px;">
Max size: 2MB | JPG, PNG, GIF
</div>
</div>

<div class="form-row">
<div class="form-group">
<label class="form-label">Full Name *</label>
<input type="text" id="profileName" class="form-input" placeholder="Enter your full name" required>
</div>
<div class="form-group">
<label class="form-label">Email</label>
<input type="email" id="profileEmail" class="form-input" readonly style="background: #F5F9F8;">
</div>
</div>

<div class="form-row">
<div class="form-group">
<label class="form-label">Phone Number *</label>
<input type="tel" id="profilePhone" class="form-input" placeholder="+91 XXXXX XXXXX" required>
</div>
<div class="form-group">
<label class="form-label">Date of Birth *</label>
<input type="date" id="profileDOB" class="form-input" required>
</div>
</div>

<div class="form-row">
<div class="form-group">
<label class="form-label">Gender *</label>
<select id="profileGender" class="form-select" required>
<option value="">Select gender</option>
<option value="Male">Male</option>
<option value="Female">Female</option>
<option value="Non-binary">Non-binary</option>
<option value="Prefer not to say">Prefer not to say</option>
</select>
</div>
<div class="form-group">
<label class="form-label">City *</label>
<input type="text" id="profileCity" class="form-input" placeholder="Enter your city" required>
</div>
</div>

<div class="form-group">
<label class="form-label">Address</label>
<textarea id="profileAddress" class="form-textarea" placeholder="Enter your complete address" style="min-height: 60px;"></textarea>
</div>

<div style="border-top: 2px solid #E5E7EB; padding-top: 20px; margin-top: 10px;">
<h3 style="color: #2C3E50; font-size: 18px; margin-bottom: 15px;">Emergency Contact (Optional)</h3>
<div class="form-row">
<div class="form-group">
<label class="form-label">Contact Name</label>
<input type="text" id="profileEmergencyName" class="form-input" placeholder="Full name">
</div>
<div class="form-group">
<label class="form-label">Contact Phone</label>
<input type="tel" id="profileEmergencyPhone" class="form-input" placeholder="+91 XXXXX XXXXX">
</div>
</div>
</div>

<button type="submit" class="btn-save">
<i class="fas fa-save"></i> Save Profile
</button>

<!-- Danger Zone - Delete Account -->
<div class="danger-zone">
<h3><i class="fas fa-exclamation-triangle"></i> Danger Zone</h3>
<p>Once you delete your account, there is no going back. This action cannot be undone and will permanently remove all your data including bookings and session history.</p>
<button type="button" class="btn-delete-account" onclick="confirmDeleteAccount()">
<i class="fas fa-trash-alt"></i> Delete My Account
</button>
</div>
</form>
</div>
</div>

<!-- Reschedule Modal -->
<div id="rescheduleModal" class="modal">
<div class="modal-content">
<div class="modal-header">
<h2 class="modal-title">Request Reschedule</h2>
<button class="close-modal" onclick="closeRescheduleModal()">&times;</button>
</div>
<form class="reschedule-form" onsubmit="submitReschedule(event)">
<div class="form-group">
<label class="form-label">New Date</label>
<input type="date" id="rescheduleDate" class="form-input" required>
</div>
<div class="form-group">
<label class="form-label">New Time</label>
<select id="rescheduleTime" class="form-select" required>
<option value="">Select time</option>
<option value="09:00 AM">09:00 AM</option>
<option value="10:00 AM">10:00 AM</option>
<option value="11:00 AM">11:00 AM</option>
<option value="02:00 PM">02:00 PM</option>
<option value="03:00 PM">03:00 PM</option>
<option value="04:00 PM">04:00 PM</option>
<option value="05:00 PM">05:00 PM</option>
</select>
</div>
<div class="form-group">
<label class="form-label">Reason (Optional)</label>
<textarea id="rescheduleReason" class="form-textarea" placeholder="Let your therapist know why you need to reschedule"></textarea>
</div>
<button type="submit" class="btn-save">
<i class="fas fa-calendar-alt"></i> Send Reschedule Request
</button>
</form>
</div>
</div>

<!-- Delete Account Confirmation Modal -->
<div id="deleteAccountModal" class="modal">
<div class="modal-content" style="max-width: 500px;">
<div class="modal-header">
<h2 class="modal-title" style="color: #DC2626;">
<i class="fas fa-exclamation-circle"></i> Delete Account
</h2>
<button class="close-modal" onclick="closeDeleteAccountModal()">&times;</button>
</div>
<div style="padding: 20px 0;">
<p style="color: #2C3E50; font-size: 16px; line-height: 1.6; margin-bottom: 20px;">
Are you sure you want to delete your account? This action will:
</p>
<ul style="color: #6B7280; font-size: 14px; line-height: 1.8; margin-bottom: 25px; padding-left: 25px;">
<li>Permanently delete your profile and personal information</li>
<li>Cancel all pending and confirmed bookings</li>
<li>Remove all your session history</li>
<li>Revoke access to your account immediately</li>
</ul>
<div style="background: #FEE2E2; border: 2px solid #EF4444; border-radius: 8px; padding: 15px; margin-bottom: 25px;">
<p style="color: #991B1B; font-weight: 700; margin: 0; font-size: 14px;">
‚ö†Ô∏è This action cannot be undone!
</p>
</div>
<div class="form-group">
<label class="form-label" style="color: #DC2626;">
Type "DELETE" to confirm:
</label>
<input type="text" id="deleteConfirmation" class="form-input" 
placeholder="Type DELETE in capital letters" 
style="border-color: #EF4444;">
</div>
<div style="display: flex; gap: 10px; margin-top: 25px;">
<button type="button" onclick="closeDeleteAccountModal()" 
style="flex: 1; padding: 14px; background: #6B7280; color: white; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; transition: background 0.3s;">
<i class="fas fa-times"></i> Cancel
</button>
<button type="button" onclick="executeDeleteAccount()" 
style="flex: 1; padding: 14px; background: #EF4444; color: white; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; transition: background 0.3s;">
<i class="fas fa-trash-alt"></i> Yes, Delete Forever
</button>
</div>
</div>
</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="app.js"></script>
<script>
let currentUser = null;
let currentUserProfile = null;
let allTherapists = [];
let currentRescheduleBookingId = null;
let uploadedProfilePicture = null;
let isProfileComplete = false;

document.addEventListener('DOMContentLoaded', async function() {
currentUser = JSON.parse(localStorage.getItem('user'));
console.log('üîµ User dashboard loaded. User:', currentUser);

if (!currentUser || currentUser.role !== 'user') {
alert('Please login as a user to access this page');
window.location.href = 'login.html';
return;
}

// Set max date for DOB (18 years ago) and min date for future dates
const today = new Date();
const maxDOB = new Date(today.getFullYear() - 18, today.getMonth(), today.getDate());
const minFuture = today.toISOString().split('T')[0];
document.getElementById('profileDOB').max = maxDOB.toISOString().split('T')[0];
document.querySelectorAll('input[type="date"]').forEach(input => {
if (input.id !== 'profileDOB') {
input.min = minFuture;
}
});

await loadUserProfile();
await loadTherapists();
await loadBookings();
});

function checkProfileComplete() {
if (!currentUserProfile) return false;

const required = [
currentUserProfile.full_name,
currentUserProfile.phone,
currentUserProfile.date_of_birth,
currentUserProfile.gender,
currentUserProfile.city
];

isProfileComplete = required.every(field => field && field.toString().trim() !== '');

console.log('üîµ Profile complete check:', {
full_name: currentUserProfile.full_name,
phone: currentUserProfile.phone,
date_of_birth: currentUserProfile.date_of_birth,
gender: currentUserProfile.gender,
city: currentUserProfile.city,
isComplete: isProfileComplete
});

if (!isProfileComplete) {
document.getElementById('profileIncompleteBanner').style.display = 'block';
} else {
document.getElementById('profileIncompleteBanner').style.display = 'none';
}

return isProfileComplete;
}

async function loadUserProfile() {
console.log('üîµ Loading user profile...');
console.log('üîµ Current user ID:', currentUser.id);

try {
// Try with maybeSingle()
let { data, error } = await window.supabaseClient
.from('profiles')
.select('*')
.eq('user_id', currentUser.id)
.maybeSingle();

console.log('üîµ Profile query result:', { data, error });

if (error) {
console.error('üî¥ Profile query error:', error);
throw error;
}

if (!data) {
console.log('üü° No profile found, creating one...');
// Create profile if it doesn't exist
const { data: newProfile, error: createError } = await window.supabaseClient
.from('profiles')
.insert([{
user_id: currentUser.id,
email: currentUser.email,
role: currentUser.role,
full_name: null,
phone: null,
date_of_date: null,
date_of_birth: null,
gender: null,
city: null,
address: null,
emergency_contact_name: null,
emergency_contact_phone: null,
profile_picture_url: null
}])
.select()
.single();

if (createError) throw createError;
data = newProfile;
console.log('üü¢ Profile created:', data);
}

currentUserProfile = data;
document.getElementById('userName').textContent = data.full_name || currentUser.email;
checkProfileComplete();
console.log('üü¢ User profile loaded:', data);
} catch (error) {
console.error('üî¥ Error loading profile:', error);
document.getElementById('userName').textContent = currentUser.email;
document.getElementById('profileIncompleteBanner').style.display = 'block';
}
}

async function loadTherapists() {
console.log('üîµ Loading therapists...');
const container = document.getElementById('therapistsGrid');

try {
const { data: therapists, error } = await window.supabaseClient
.from('Therapists')
.select('*')
.order('Name', { ascending: true });

console.log('üîµ Therapists ', therapists);

if (error) throw error;

if (!therapists || therapists.length === 0) {
container.innerHTML = '<div class="empty-state">No therapists available at the moment</div>';
return;
}

allTherapists = therapists;
displayTherapists(therapists);
console.log('üü¢ Loaded', therapists.length, 'therapists');
} catch (error) {
console.error('üî¥ Error loading therapists:', error);
container.innerHTML = '<div class="empty-state">Error loading therapists: ' + error.message + '</div>';
}
}

function displayTherapists(therapists) {
const container = document.getElementById('therapistsGrid');
const bookingDisabled = !isProfileComplete;

container.innerHTML = therapists.map(t => `
<div class="therapist-card">
<h3 class="therapist-name">Dr. ${t.Name || 'Therapist'}</h3>
<div class="therapist-specialty">${t.Specialization || 'General Therapy'}</div>
<div class="therapist-fee">‚Çπ${t.fee || 0} per session</div>
${t.bio ? `<div class="therapist-bio">${t.bio}</div>` : ''}
${bookingDisabled ? `
<div style="background: #FEF3C7; padding: 15px; border-radius: 8px; margin-bottom: 15px; text-align: center;">
<p style="color: #92400E; font-size: 14px; margin: 0 0 10px 0; font-weight: 600;">
<i class="fas fa-lock"></i> Complete your profile to book
</p>
<button onclick="openProfileModal()" style="background: #F59E0B; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600;">
Complete Profile
</button>
</div>
` : `
<div class="booking-form">
<input type="date"
id="date-${t.id}"
class="form-input"
min="${new Date().toISOString().split('T')[0]}"
required>
<select id="time-${t.id}" class="form-select" required>
<option value="">Select time</option>
<option value="09:00 AM">09:00 AM</option>
<option value="10:00 AM">10:00 AM</option>
<option value="11:00 AM">11:00 AM</option>
<option value="02:00 PM">02:00 PM</option>
<option value="03:00 PM">03:00 PM</option>
<option value="04:00 PM">04:00 PM</option>
<option value="05:00 PM">05:00 PM</option>
</select>
<textarea id="problem-${t.id}"
class="form-textarea"
placeholder="Briefly describe what you'd like to work on *"
required></textarea>
<button class="btn-book" onclick="bookSession('${t.id}', '${t.Name}', ${t.fee})">
<i class="fas fa-calendar-plus"></i> Book Session
</button>
</div>
`}
</div>
`).join('');
}

function filterTherapists() {
const specialization = document.getElementById('specializationFilter').value;
if (specialization === 'all') {
displayTherapists(allTherapists);
} else {
const filtered = allTherapists.filter(t => t.Specialization === specialization);
displayTherapists(filtered);
}
}

async function bookSession(therapistId, therapistName, fee) {
if (!isProfileComplete) {
alert('‚ö†Ô∏è Please complete your profile before booking a session');
openProfileModal();
return;
}

const date = document.getElementById('date-' + therapistId).value;
const time = document.getElementById('time-' + therapistId).value;
const problemDesc = document.getElementById('problem-' + therapistId).value.trim();

if (!date || !time) {
alert('Please select both date and time');
return;
}

if (!problemDesc) {
alert('Please describe what you\'d like to work on');
return;
}

console.log('üîµ Booking session:', { therapistId, date, time, problemDesc });

try {
// Check for booking conflicts (same date + time slot)
const { data: conflictingBookings, error: conflictError } = await window.supabaseClient
.from('Bookings')
.select('*')
.eq('user_id', currentUser.id)
.eq('session_date', date)
.eq('start_time', time)
.in('status', ['pending', 'confirmed']);

if (conflictError) throw conflictError;

if (conflictingBookings && conflictingBookings.length > 0) {
alert('‚ö†Ô∏è You already have a booking at this time slot. Please choose a different time.');
return;
}

// Calculate session end time (assuming 1-hour sessions)
const startHour = parseInt(time.split(':')[0]);
const isPM = time.includes('PM');
let endHour = startHour + 1;
if (isPM && startHour !== 12) {
endHour = (startHour + 1) % 12;
}
const endTime = endHour + ':00 ' + (isPM ? 'PM' : 'AM');

// Create booking
const bookingData = {
user_id: currentUser.id,
therapist_id: therapistId,
session_date: date,
start_time: time,
end_time: endTime,
amount: fee || 0,
status: 'pending',
patient_name: currentUserProfile?.full_name || currentUser.email,
patient_email: currentUser.email,
problem_description: problemDesc
};

console.log('üîµ Creating booking:', bookingData);

const { data, error } = await window.supabaseClient
.from('Bookings')
.insert([bookingData])
.select();

if (error) throw error;

console.log('üü¢ Booking created:', data);
alert('‚úÖ Session booked successfully! The therapist will confirm your appointment soon.');

// Clear form
document.getElementById('date-' + therapistId).value = '';
document.getElementById('time-' + therapistId).value = '';
document.getElementById('problem-' + therapistId).value = '';

// Reload bookings
await loadBookings();
} catch (error) {
console.error('üî¥ Booking error:', error);
alert('Error booking session: ' + error.message);
}
}

async function loadBookings() {
console.log('üîµ Loading bookings...');
const container = document.getElementById('bookingsList');
const sortBy = document.getElementById('bookingSortFilter').value;
const statusFilter = document.getElementById('bookingStatusFilter').value;

console.log('üîµ Filters:', { sortBy, statusFilter, userId: currentUser.id });

try {
let query = window.supabaseClient
.from('Bookings')
.select('*')
.eq('user_id', currentUser.id);

// Apply status filter
if (statusFilter !== 'all') {
query = query.eq('status', statusFilter);
}

// Apply sorting
if (sortBy === 'upcoming') {
query = query.order('session_date', { ascending: true });
} else {
query = query.order('session_date', { ascending: false });
}

const { data: bookings, error } = await query;

console.log('üîµ Bookings query result:', { bookings, error, count: bookings?.length });

// DEBUG: Log user_id values in bookings for troubleshooting
if (bookings && bookings.length > 0) {
console.log('üîµ Sample booking user_ids:', bookings.slice(0, 3).map(b => ({ id: b.id, user_id: b.user_id })));
// Verify user_id matches
const userIdMatches = bookings.every(b => b.user_id === currentUser.id);
console.log('üîµ All user_id matches current user:', userIdMatches);
}

if (error) throw error;

if (!bookings || bookings.length === 0) {
container.innerHTML = '<div class="empty-state">No bookings found</div>';
return;
}

// Get therapist details
const therapistIds = [...new Set(bookings.map(b => b.therapist_id))];
const { data: therapists } = await window.supabaseClient
.from('Therapists')
.select('id, Name, Specialization')
.in('id', therapistIds);

const therapistMap = {};
if (therapists) {
therapists.forEach(t => {
therapistMap[t.id] = t;
});
}

// Display bookings
container.innerHTML = bookings.map(booking => {
const therapist = therapistMap[booking.therapist_id] || {};
const statusClass = 'status-' + booking.status;
const hasTherapistReschedule = booking.therapist_reschedule_requested === true;

return `
<div class="booking-card">
<div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
<div>
<h3 style="font-size: 20px; font-weight: 700; color: #2C3E50; margin: 0 0 5px 0;">
Dr. ${therapist.Name || 'Therapist'}
</h3>
<div style="color: #5A9B8E; font-size: 14px; font-weight: 600; margin-bottom: 10px;">
${therapist.Specialization || 'Therapy'}
</div>
<span class="status-badge ${statusClass}">${booking.status.toUpperCase()}</span>
</div>
</div>
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px; font-size: 14px; margin-bottom: 15px;">
<div>
<div style="color: #6B7280; font-weight: 600; margin-bottom: 4px;">DATE</div>
<div style="color: #2C3E50;">${formatDate(booking.session_date)}</div>
</div>
<div>
<div style="color: #6B7280; font-weight: 600; margin-bottom: 4px;">TIME</div>
<div style="color: #2C3E50;">${booking.start_time || 'TBD'}</div>
</div>
<div>
<div style="color: #6B7280; font-weight: 600; margin-bottom: 4px;">FEE</div>
<div style="color: #2C3E50;">‚Çπ${booking.amount || 0}</div>
</div>
</div>
${booking.problem_description ? `
<div class="info-box">
<div class="info-box-title"><i class="fas fa-comment-dots"></i> Your Concern</div>
<div class="info-box-text">${booking.problem_description}</div>
</div>
` : ''}
${hasTherapistReschedule ? `
<div style="margin-top: 15px; padding: 15px; background: #FFF3CD; border-radius: 8px; border-left: 4px solid #F59E0B;">
<div style="font-weight: 700; color: #856404; margin-bottom: 10px;">
<i class="fas fa-info-circle"></i> Therapist Requested Reschedule
</div>
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px; font-size: 14px; margin-bottom: 10px;">
<div>
<div style="color: #856404; font-weight: 600; margin-bottom: 4px;">SUGGESTED DATE</div>
<div style="color: #2C3E50; font-weight: 700;">${formatDate(booking.therapist_reschedule_date)}</div>
</div>
<div>
<div style="color: #856404; font-weight: 600; margin-bottom: 4px;">SUGGESTED TIME</div>
<div style="color: #2C3E50; font-weight: 700;">${booking.therapist_reschedule_time || 'N/A'}</div>
</div>
</div>
${booking.therapist_reschedule_reason ? `
<div style="margin-top: 10px;">
<div style="color: #856404; font-weight: 600; margin-bottom: 4px; font-size: 12px;">REASON</div>
<div style="color: #2C3E50; font-size: 13px;">${booking.therapist_reschedule_reason}</div>
</div>
` : ''}
<div class="action-buttons">
<button class="btn-accept" onclick="acceptTherapistReschedule('${booking.id}', '${booking.therapist_reschedule_date}', '${booking.therapist_reschedule_time}')">
<i class="fas fa-check"></i> Accept New Time
</button>
<button class="btn-reschedule" onclick="openRescheduleModal('${booking.id}')">
<i class="fas fa-calendar-alt"></i> Suggest Different Time
</button>
</div>
</div>
` : ''}
${booking.next_session_notes ? `
<div style="margin-top: 15px; padding: 15px; background: #E0F2F1; border-radius: 8px; border-left: 4px solid #5A9B8E;">
<div style="font-weight: 700; color: #2C3E50; margin-bottom: 8px; font-size: 14px;">
<i class="fas fa-clipboard-list"></i> Preparation for Next Session
</div>
<div style="color: #4B5563; font-size: 13px; line-height: 1.5;">${booking.next_session_notes}</div>
</div>
` : ''}
${booking.status === 'confirmed' && booking.meeting_link ? `
<div style="margin-top: 15px; padding: 15px; background: #D4EDDA; border-radius: 8px; border-left: 4px solid #28a745;">
<div style="font-weight: 700; color: #155724; margin-bottom: 10px;">
<i class="fas fa-video"></i> Session Confirmed
</div>
<div style="margin-bottom: 15px;">
<div style="color: #155724; font-size: 12px; font-weight: 600; margin-bottom: 5px;">MEETING LINK</div>
<a href="${booking.meeting_link}" target="_blank" style="color: #5A9B8E; text-decoration: underline; word-break: break-all;">
${booking.meeting_link}
</a>
</div>
<div class="action-buttons">
<a href="${booking.meeting_link}" target="_blank" class="btn-join">
<i class="fas fa-video"></i> Join Session
</a>
<button class="btn-reschedule" onclick="openRescheduleModal('${booking.id}')">
<i class="fas fa-calendar-alt"></i> Request Reschedule
</button>
</div>
</div>
` : ''}
${booking.status === 'pending' && !hasTherapistReschedule ? `
<div class="action-buttons">
<button class="btn-reschedule" onclick="openRescheduleModal('${booking.id}')">
<i class="fas fa-calendar-alt"></i> Request Reschedule
</button>
<button class="btn-cancel" onclick="cancelBooking('${booking.id}')">
<i class="fas fa-times"></i> Cancel Booking
</button>
</div>
` : ''}
${booking.status === 'completed' ? `
<div style="margin-top: 15px; padding: 15px; background: #D1ECF1; border-radius: 8px; border-left: 4px solid #0C5460;">
<div style="color: #0C5460; font-weight: 600; font-size: 14px;">
<i class="fas fa-check-double"></i> Session Completed
</div>
</div>
` : ''}
</div>
`;
}).join('');

console.log('üü¢ Loaded', bookings.length, 'bookings');
} catch (error) {
console.error('üî¥ Error loading bookings:', error);
container.innerHTML = '<div class="empty-state">Error: ' + error.message + '</div>';
}
}

function formatDate(dateString) {
if (!dateString) return 'N/A';
const date = new Date(dateString);
return date.toLocaleDateString('en-IN', {
year: 'numeric',
month: 'short',
day: 'numeric'
});
}

function handleProfilePictureChange(event) {
const file = event.target.files[0];
if (!file) return;

// Validate file size (2MB max)
if (file.size > 2 * 1024 * 1024) {
alert('File size must be less than 2MB');
return;
}

// Validate file type
if (!file.type.startsWith('image/')) {
alert('Please select an image file');
return;
}

uploadedProfilePicture = file;

// Preview image
const reader = new FileReader();
reader.onload = function(e) {
document.getElementById('profilePicturePreview').innerHTML = `
<img src="${e.target.result}" class="profile-picture-preview" alt="Profile">
`;
};
reader.readAsDataURL(file);
}

async function acceptTherapistReschedule(bookingId, newDate, newTime) {
console.log('üîµ Accepting therapist reschedule:', bookingId);

try {
const { data, error } = await window.supabaseClient
.from('Bookings')
.update({
session_date: newDate,
start_time: newTime,
therapist_reschedule_requested: false,
therapist_reschedule_date: null,
therapist_reschedule_time: null,
therapist_reschedule_reason: null
})
.eq('id', bookingId)
.select();

if (error) throw error;

console.log('üü¢ Reschedule accepted:', data);
alert('‚úÖ Reschedule accepted! Your session has been updated.');
await loadBookings();
} catch (error) {
console.error('üî¥ Error accepting reschedule:', error);
alert('Error: ' + error.message);
}
}

function openRescheduleModal(bookingId) {
currentRescheduleBookingId = bookingId;
const today = new Date().toISOString().split('T')[0];
document.getElementById('rescheduleDate').min = today;
document.getElementById('rescheduleModal').classList.add('active');
}

function closeRescheduleModal() {
currentRescheduleBookingId = null;
document.getElementById('rescheduleDate').value = '';
document.getElementById('rescheduleTime').value = '';
document.getElementById('rescheduleReason').value = '';
document.getElementById('rescheduleModal').classList.remove('active');
}

async function submitReschedule(event) {
event.preventDefault();
console.log('üîµ Submitting reschedule request...');

const newDate = document.getElementById('rescheduleDate').value;
const newTime = document.getElementById('rescheduleTime').value;
const reason = document.getElementById('rescheduleReason').value;

try {
const { data, error } = await window.supabaseClient
.from('Bookings')
.update({
reschedule_requested: true,
reschedule_new_date: newDate,
reschedule_new_start_time: newTime,
reschedule_reason: reason || null,
therapist_reschedule_requested: false,
therapist_reschedule_date: null,
therapist_reschedule_time: null,
therapist_reschedule_reason: null
})
.eq('id', currentRescheduleBookingId)
.select();

if (error) throw error;

console.log('üü¢ Reschedule request sent:', data);
alert('‚úÖ Reschedule request sent to therapist!');
closeRescheduleModal();
await loadBookings();
} catch (error) {
console.error('üî¥ Error requesting reschedule:', error);
alert('Error: ' + error.message);
}
}

async function cancelBooking(bookingId) {
if (!confirm('Are you sure you want to cancel this booking?')) {
return;
}

console.log('üîµ Cancelling booking:', bookingId);

try {
const { data, error } = await window.supabaseClient
.from('Bookings')
.delete()
.eq('id', bookingId)
.select();

if (error) throw error;

console.log('üü¢ Booking cancelled:', data);
alert('‚úÖ Booking cancelled successfully');
await loadBookings();
} catch (error) {
console.error('üî¥ Error cancelling booking:', error);
alert('Error: ' + error.message);
}
}

function openProfileModal() {
console.log('üîµ Opening profile modal. Current profile:', currentUserProfile);

if (currentUserProfile) {
document.getElementById('profileName').value = currentUserProfile.full_name || '';
document.getElementById('profileEmail').value = currentUser.email;
document.getElementById('profilePhone').value = currentUserProfile.phone || '';
document.getElementById('profileDOB').value = currentUserProfile.date_of_birth || '';
document.getElementById('profileGender').value = currentUserProfile.gender || '';
document.getElementById('profileCity').value = currentUserProfile.city || '';
document.getElementById('profileAddress').value = currentUserProfile.address || '';
document.getElementById('profileEmergencyName').value = currentUserProfile.emergency_contact_name || '';
document.getElementById('profileEmergencyPhone').value = currentUserProfile.emergency_contact_phone || '';

// Display existing profile picture if available
if (currentUserProfile.profile_picture_url) {
document.getElementById('profilePicturePreview').innerHTML = `
<img src="${currentUserProfile.profile_picture_url}" class="profile-picture-preview" alt="Profile">
`;
} else {
document.getElementById('profilePicturePreview').innerHTML = `
<div class="profile-picture-placeholder">
<i class="fas fa-user"></i>
</div>
`;
}
}

document.getElementById('profileModal').classList.add('active');
}

function closeProfileModal() {
uploadedProfilePicture = null;
document.getElementById('profileModal').classList.remove('active');
}

async function saveProfile(event) {
event.preventDefault();
console.log('üîµ Saving profile...');

try {
let profilePictureUrl = currentUserProfile?.profile_picture_url || null;

// Upload profile picture if selected
if (uploadedProfilePicture) {
console.log('üîµ Uploading profile picture...');
const fileExt = uploadedProfilePicture.name.split('.').pop();
const fileName = `${currentUser.id}-${Date.now()}.${fileExt}`;
const filePath = `${fileName}`;

const { data: uploadData, error: uploadError } = await window.supabaseClient.storage
.from('profile-pictures')
.upload(filePath, uploadedProfilePicture, {
cacheControl: '3600',
upsert: true
});

if (uploadError) throw uploadError;

// Get public URL
const { data: urlData } = window.supabaseClient.storage
.from('profile-pictures')
.getPublicUrl(filePath);

profilePictureUrl = urlData.publicUrl;
console.log('üü¢ Profile picture uploaded:', profilePictureUrl);
}

const profileData = {
full_name: document.getElementById('profileName').value.trim(),
phone: document.getElementById('profilePhone').value.trim(),
date_of_birth: document.getElementById('profileDOB').value || null,
gender: document.getElementById('profileGender').value || null,
city: document.getElementById('profileCity').value.trim(),
address: document.getElementById('profileAddress').value.trim() || null,
emergency_contact_name: document.getElementById('profileEmergencyName').value.trim() || null,
emergency_contact_phone: document.getElementById('profileEmergencyPhone').value.trim() || null,
profile_picture_url: profilePictureUrl
};

console.log('üîµ Updating profile with ', profileData);

const { data, error } = await window.supabaseClient
.from('profiles')
.update(profileData)
.eq('user_id', currentUser.id)
.select()
.single();

if (error) throw error;

console.log('üü¢ Profile updated:', data);
alert('‚úÖ Profile updated successfully!');
currentUserProfile = data;
document.getElementById('userName').textContent = currentUserProfile.full_name || currentUser.email;
checkProfileComplete();
displayTherapists(allTherapists);
closeProfileModal();
} catch (error) {
console.error('üî¥ Error saving profile:', error);
alert('Error: ' + error.message);
}
}

// Delete Account Functions
function confirmDeleteAccount() {
document.getElementById('deleteAccountModal').classList.add('active');
document.getElementById('deleteConfirmation').value = '';
}

function closeDeleteAccountModal() {
document.getElementById('deleteAccountModal').classList.remove('active');
document.getElementById('deleteConfirmation').value = '';
}

async function executeDeleteAccount() {
const confirmation = document.getElementById('deleteConfirmation').value;

if (confirmation !== 'DELETE') {
alert('‚ùå Please type "DELETE" exactly as shown to confirm account deletion.');
return;
}

console.log('üîµ Initiating account deletion for user:', currentUser.id);

try {
// 1. Delete all user bookings
console.log('üîµ Deleting user bookings...');
const { error: bookingsError } = await window.supabaseClient
.from('Bookings')
.delete()
.eq('user_id', currentUser.id);

if (bookingsError) {
console.error('üî¥ Error deleting bookings:', bookingsError);
throw bookingsError;
}
console.log('üü¢ Bookings deleted');

// 2. Delete profile picture from storage if exists
if (currentUserProfile?.profile_picture_url) {
console.log('üîµ Deleting profile picture...');
try {
const fileName = currentUserProfile.profile_picture_url.split('/').pop();
const { error: storageError } = await window.supabaseClient.storage
.from('profile-pictures')
.remove([fileName]);

if (storageError) {
console.warn('üü° Could not delete profile picture:', storageError);
}
} catch (storageErr) {
console.warn('üü° Profile picture deletion failed:', storageErr);
}
}

// 3. Delete user profile
console.log('üîµ Deleting user profile...');
const { error: profileError } = await window.supabaseClient
.from('profiles')
.delete()
.eq('user_id', currentUser.id);

if (profileError) {
console.error('üî¥ Error deleting profile:', profileError);
throw profileError;
}
console.log('üü¢ Profile deleted');

// 4. Sign out user (this effectively revokes access)
console.log('üîµ Signing out user...');
await window.supabaseClient.auth.signOut();

console.log('üü¢ Account deletion completed successfully');

// Clear local storage
localStorage.removeItem('user');
localStorage.clear();

alert('‚úÖ Your account has been permanently deleted. You will now be redirected to the homepage.');

// Redirect to homepage
window.location.href = 'index.html';

} catch (error) {
console.error('üî¥ Error during account deletion:', error);
alert('‚ùå Error deleting account: ' + error.message + '\n\nPlease contact support if the problem persists.');
}
}

// Update window click handler to include delete modal
window.onclick = function(event) {
const profileModal = document.getElementById('profileModal');
const rescheduleModal = document.getElementById('rescheduleModal');
const deleteModal = document.getElementById('deleteAccountModal');

if (event.target === profileModal) {
closeProfileModal();
}
if (event.target === rescheduleModal) {
closeRescheduleModal();
}
if (event.target === deleteModal) {
closeDeleteAccountModal();
}
}
</script>
</body>
</html>
