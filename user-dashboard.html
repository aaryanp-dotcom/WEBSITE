<!-- Load Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="app.js"></script>

<script>
// ===== FIXED USER DASHBOARD - COMPLETE SCRIPT =====
const supabaseClient = window.supabaseClient;
let currentUser = null;
let currentProfile = null;

// Initialize dashboard on page load
document.addEventListener('DOMContentLoaded', async function() {
    try {
        console.log('üîµ Initializing user dashboard...');
        
        // ‚úÖ CRITICAL FIX: Get user from Supabase Auth (not localStorage)
        const { data: { user: authUser }, error: authError } = await supabaseClient.auth.getUser();
        
        if (authError || !authUser) {
            console.error('‚ùå Auth error:', authError);
            alert('Session expired. Please login again.');
            window.location.href = 'login.html';
            return;
        }
        
        console.log('‚úÖ Logged in user:', authUser.id, authUser.email);
        
        // Set current user with correct ID from auth
        currentUser = {
            id: authUser.id,
            email: authUser.email,
            role: 'user'
        };
        
        // Load all data
        await loadProfileData();
        await loadBookings();
        
        console.log('‚úÖ Dashboard initialized successfully');
        
    } catch (error) {
        console.error('‚ùå Error initializing dashboard:', error);
        alert('Error loading dashboard. Please try again.');
        window.location.href = 'login.html';
    }
});

// ===== LOAD PROFILE DATA =====
async function loadProfileData() {
    try {
        console.log('üîµ Loading profile for user:', currentUser.id);
        
        const { data: profile, error } = await supabaseClient
            .from('profiles')
            .select('*')
            .eq('user_id', currentUser.id)
            .single();
        
        if (error) {
            console.error('‚ùå Profile load error:', error);
            throw error;
        }
        
        console.log('‚úÖ Profile loaded:', profile);
        currentProfile = profile;
        
        // Update UI with profile data
        if (profile) {
            // Update user name in header
            const userNameElement = document.getElementById('userName');
            if (userNameElement) {
                userNameElement.textContent = profile.full_name || 'User';
            }
            
            // Update welcome message
            const welcomeElement = document.querySelector('.welcome-title');
            if (welcomeElement) {
                welcomeElement.textContent = `Welcome back, ${profile.full_name || 'User'}!`;
            }
        }
        
    } catch (error) {
        console.error('‚ùå Error loading profile:', error);
    }
}

// ===== LOAD BOOKINGS =====
async function loadBookings() {
    try {
        console.log('üîµ Loading bookings for user:', currentUser.id);
        
        const { data: bookings, error } = await supabaseClient
            .from('Bookings')
            .select('*')
            .eq('user_id', currentUser.id)
            .order('session_date', { ascending: false });
        
        if (error) {
            console.error('‚ùå Bookings load error:', error);
            throw error;
        }
        
        console.log('‚úÖ Bookings loaded:', bookings);
        
        // Display bookings
        const bookingsContainer = document.getElementById('bookingsList');
        if (!bookingsContainer) return;
        
        if (!bookings || bookings.length === 0) {
            bookingsContainer.innerHTML = '<p class="empty-state">üìÖ No bookings yet. Book a session with a therapist to get started!</p>';
            return;
        }
        
        bookingsContainer.innerHTML = '';
        
        for (const booking of bookings) {
            // Fetch therapist details
            const { data: therapist } = await supabaseClient
                .from('Therapists')
                .select('Name, Specialization, phone, email')
                .eq('id', booking.therapist_id)
                .single();
            
            const bookingCard = createBookingCard(booking, therapist);
            bookingsContainer.innerHTML += bookingCard;
        }
        
    } catch (error) {
        console.error('‚ùå Error loading bookings:', error);
        const bookingsContainer = document.getElementById('bookingsList');
        if (bookingsContainer) {
            bookingsContainer.innerHTML = '<p class="empty-state">‚ùå Error loading bookings. Please refresh the page.</p>';
        }
    }
}

// ===== CREATE BOOKING CARD HTML =====
function createBookingCard(booking, therapist) {
    const statusClass = `status-${booking.status}`;
    const therapistName = therapist ? therapist.Name : 'Unknown Therapist';
    const therapistSpec = therapist ? therapist.Specialization : '';
    
    return `
        <div class="appointment-card">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                <div>
                    <h3 class="patient-name">${therapistName}</h3>
                    <p class="patient-email">${therapistSpec}</p>
                </div>
                <span class="status-badge ${statusClass}">${booking.status}</span>
            </div>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 15px;">
                <div>
                    <strong>üìÖ Date:</strong> ${new Date(booking.session_date).toLocaleDateString()}
                </div>
                <div>
                    <strong>‚è∞ Time:</strong> ${booking.session_time || 'TBD'}
                </div>
            </div>
            ${booking.problem_description ? `<div style="margin-bottom: 15px;"><strong>Problem:</strong> ${booking.problem_description}</div>` : ''}
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                ${booking.status === 'pending' ? `
                    <button class="btn-reject" onclick="cancelBooking('${booking.id}')">Cancel Booking</button>
                ` : ''}
                ${booking.status === 'confirmed' ? `
                    <button class="btn-reschedule" onclick="requestReschedule('${booking.id}')">Request Reschedule</button>
                ` : ''}
            </div>
        </div>
    `;
}

// ===== OPEN PROFILE MODAL =====
function openProfileModal() {
    if (!currentProfile) {
        alert('Profile data not loaded yet. Please refresh the page.');
        return;
    }
    
    // Populate modal with current data
    document.getElementById('profileFullName').value = currentProfile.full_name || '';
    document.getElementById('profileEmail').value = currentProfile.email || '';
    document.getElementById('profilePhone').value = currentProfile.phone || '';
    document.getElementById('profileDOB').value = currentProfile.date_of_birth || '';
    document.getElementById('profileGender').value = currentProfile.gender || '';
    document.getElementById('profileCity').value = currentProfile.city || '';
    document.getElementById('profileAddress').value = currentProfile.address || '';
    document.getElementById('profileEmergencyName').value = currentProfile.emergency_contact_name || '';
    document.getElementById('profileEmergencyPhone').value = currentProfile.emergency_contact_phone || '';
    
    // ‚úÖ FIX: Set max date for birthday to prevent future dates
    const today = new Date();
    document.getElementById('profileDOB').max = today.toISOString().split('T')[0];
    
    // Show modal
    document.getElementById('profileModal').classList.add('active');
}

// ===== CLOSE PROFILE MODAL =====
function closeProfileModal() {
    document.getElementById('profileModal').classList.remove('active');
}

// ===== SAVE PROFILE =====
async function saveProfile() {
    try {
        const updatedProfile = {
            full_name: document.getElementById('profileFullName').value.trim(),
            phone: document.getElementById('profilePhone').value.trim(),
            date_of_birth: document.getElementById('profileDOB').value,
            gender: document.getElementById('profileGender').value,
            city: document.getElementById('profileCity').value.trim(),
            address: document.getElementById('profileAddress').value.trim(),
            emergency_contact_name: document.getElementById('profileEmergencyName').value.trim(),
            emergency_contact_phone: document.getElementById('profileEmergencyPhone').value.trim()
        };
        
        console.log('üîµ Updating profile for user:', currentUser.id);
        
        const { data, error } = await supabaseClient
            .from('profiles')
            .update(updatedProfile)
            .eq('user_id', currentUser.id);
        
        if (error) {
            console.error('‚ùå Profile update error:', error);
            alert('Error updating profile: ' + error.message);
            return;
        }
        
        console.log('‚úÖ Profile updated successfully');
        alert('‚úÖ Profile updated successfully!');
        
        // Reload profile data
        await loadProfileData();
        
        // Close modal
        closeProfileModal();
        
    } catch (error) {
        console.error('‚ùå Error saving profile:', error);
        alert('Error saving profile. Please try again.');
    }
}

// ===== LOGOUT =====
async function logout() {
    try {
        await supabaseClient.auth.signOut();
        localStorage.clear();
        window.location.href = 'login.html';
    } catch (error) {
        console.error('Logout error:', error);
        window.location.href = 'login.html';
    }
}

// ===== CANCEL BOOKING (if you have this feature) =====
async function cancelBooking(bookingId) {
    if (!confirm('Are you sure you want to cancel this booking?')) return;
    
    try {
        const { error } = await supabaseClient
            .from('Bookings')
            .update({ status: 'cancelled' })
            .eq('id', bookingId);
        
        if (error) throw error;
        
        alert('‚úÖ Booking cancelled');
        await loadBookings();
    } catch (error) {
        console.error('Error:', error);
        alert('Error cancelling booking');
    }
}

// ===== REQUEST RESCHEDULE (if you have this feature) =====
async function requestReschedule(bookingId) {
    const reason = prompt('Please provide a reason for rescheduling:');
    if (!reason) return;
    
    try {
        const { error } = await supabaseClient
            .from('Bookings')
            .update({ 
                reschedule_requested: true,
                reschedule_reason: reason
            })
            .eq('id', bookingId);
        
        if (error) throw error;
        
        alert('‚úÖ Reschedule request sent to therapist');
        await loadBookings();
    } catch (error) {
        console.error('Error:', error);
        alert('Error requesting reschedule');
    }
}

// Make functions globally accessible
window.openProfileModal = openProfileModal;
window.closeProfileModal = closeProfileModal;
window.saveProfile = saveProfile;
window.logout = logout;
window.cancelBooking = cancelBooking;
window.requestReschedule = requestReschedule;
</script>
