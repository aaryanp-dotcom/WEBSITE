<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Therapist Dashboard - MindSpace</title>
  
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    .dashboard-wrapper {
      min-height: 100vh;
      background: #F5F9F8;
      padding-top: 80px;
    }

    .dashboard-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 30px 20px;
    }

    .dash-header {
      background: #FFFFFF;
      border: 1px solid #E5E7EB;
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.05);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 18px;
      flex-wrap: wrap;
      margin-bottom: 22px;
    }

    .therapist-left {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .therapist-avatar {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: linear-gradient(135deg, #5A9B8E 0%, #4A8B7E 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #FFFFFF;
      font-weight: 800;
      font-size: 20px;
    }

    .therapist-meta h1 {
      margin: 0;
      color: #5A9B8E;
      font-size: 26px;
      line-height: 1.2;
    }

    .therapist-meta p {
      margin: 6px 0 0;
      color: #6B7280;
      font-weight: 500;
      font-size: 14px;
    }

    .btn-logout {
      background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
      color: #fff;
      border: none;
      padding: 12px 20px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 700;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .btn-logout:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 14px rgba(220, 53, 69, 0.25);
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 18px;
      margin-bottom: 22px;
    }

    @media (max-width: 992px) {
      .stats-grid { grid-template-columns: repeat(2, 1fr); }
    }

    @media (max-width: 576px) {
      .stats-grid { grid-template-columns: 1fr; }
    }

    .stat-card {
      background: #FFFFFF;
      border: 1px solid #E5E7EB;
      border-radius: 16px;
      padding: 18px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.05);
    }

    .stat-label {
      color: #6B7280;
      font-weight: 700;
      font-size: 12px;
      letter-spacing: 0.6px;
      text-transform: uppercase;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .stat-value {
      margin-top: 8px;
      font-size: 30px;
      font-weight: 900;
      color: #2C3E50;
      line-height: 1;
    }

    .panel {
      background: #FFFFFF;
      border: 1px solid #E5E7EB;
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.05);
      margin-bottom: 22px;
    }

    .panel-title {
      margin: 0 0 16px;
      color: #2C3E50;
      font-size: 18px;
      font-weight: 800;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .booking-row {
      padding: 14px 0;
      border-top: 1px solid #E5E7EB;
    }

    .booking-row:first-child {
      border-top: none;
      padding-top: 0;
    }

    .booking-status {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .booking-status.pending {
      background: #FFF3CD;
      color: #856404;
    }

    .booking-status.confirmed {
      background: #D4EDDA;
      color: #155724;
    }

    .booking-status.completed {
      background: #D1ECF1;
      color: #0C5460;
    }

    .booking-status.cancelled {
      background: #F8D7DA;
      color: #721C24;
    }

    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #6B7280;
    }

    .empty-state i {
      font-size: 48px;
      color: #C9E4DE;
      margin-bottom: 16px;
    }

    .loading-state {
      text-align: center;
      padding: 40px 20px;
      color: #6B7280;
    }

    .action-buttons {
      display: flex;
      gap: 10px;
      margin-top: 10px;
      flex-wrap: wrap;
    }

    .btn-action {
      padding: 8px 16px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      font-size: 13px;
      transition: all 0.2s ease;
    }

    .btn-approve {
      background: #4caf50;
      color: white;
    }

    .btn-approve:hover {
      background: #45a049;
      transform: translateY(-2px);
    }

    .btn-reject {
      background: #f44336;
      color: white;
    }

    .btn-reject:hover {
      background: #d32f2f;
      transform: translateY(-2px);
    }

    .btn-complete {
      background: #2196F3;
      color: white;
    }

    .btn-complete:hover {
      background: #1976D2;
      transform: translateY(-2px);
    }
  </style>
</head>

<body>
  <div class="dashboard-wrapper">
    <!-- Navigation -->
    <nav class="navbar">
      <div class="nav-container">
        <a href="index.html" class="logo">
          <span class="logo-icon">ðŸ§ </span>
          <span class="logo-text">MindSpace</span>
        </a>

        <ul class="nav-links">
          <li><a href="therapist-dashboard.html" class="active">Dashboard</a></li>
          <li><a href="index.html">Home</a></li>
          <li><button class="btn-nav-login" id="navLogoutBtn" type="button">Logout</button></li>
        </ul>
      </div>
    </nav>

    <!-- Dashboard Container -->
    <main class="dashboard-container">
      <!-- Dashboard Header -->
      <section class="dash-header">
        <div class="therapist-left">
          <div class="therapist-avatar" id="therapistAvatar">T</div>
          <div class="therapist-meta">
            <h1 id="therapistName">Therapist Dashboard</h1>
            <p id="therapistSpecialization">Loading...</p>
          </div>
        </div>
        <button class="btn-logout" id="logoutBtn" type="button">
          <i class="fas fa-sign-out-alt"></i> Logout
        </button>
      </section>

      <!-- Stats Grid -->
      <section class="stats-grid">
        <div class="stat-card">
          <div class="stat-label">
            <i class="fas fa-calendar-check"></i> Total Bookings
          </div>
          <div class="stat-value" id="totalBookings">0</div>
        </div>

        <div class="stat-card">
          <div class="stat-label">
            <i class="fas fa-clock"></i> Pending
          </div>
          <div class="stat-value" id="pendingBookings">0</div>
        </div>

        <div class="stat-card">
          <div class="stat-label">
            <i class="fas fa-check-circle"></i> Confirmed
          </div>
          <div class="stat-value" id="confirmedBookings">0</div>
        </div>

        <div class="stat-card">
          <div class="stat-label">
            <i class="fas fa-star"></i> Completed
          </div>
          <div class="stat-value" id="completedBookings">0</div>
        </div>
      </section>

      <!-- Pending Bookings -->
      <section class="panel">
        <h2 class="panel-title">
          <i class="fas fa-hourglass-half"></i> Pending Booking Requests
        </h2>
        <div id="pendingBookingsList">
          <div class="loading-state">
            <i class="fas fa-spinner fa-spin"></i>
            <p>Loading pending requests...</p>
          </div>
        </div>
      </section>

      <!-- All Bookings -->
      <section class="panel">
        <h2 class="panel-title">
          <i class="fas fa-list"></i> All Bookings
        </h2>
        <div id="allBookingsList">
          <div class="loading-state">
            <i class="fas fa-spinner fa-spin"></i>
            <p>Loading bookings...</p>
          </div>
        </div>
      </section>
    </main>
  </div>

  <script>
    const SUPABASE_URL = 'https://hviqxpfnvjsqbdjfbttm.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh2aXF4cGZudmpzcWJkamZidHRtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg4NDM0NzIsImV4cCI6MjA4NDQxOTQ3Mn0.P3UWgbYx4MLMJktsXjFsAEtsNpTjqPnO31s2Oyy0BFs';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let currentTherapist = null;
    let allBookings = [];

    async function init() {
      try {
        // Check authentication
        const { data: { user }, error: authError } = await supabase.auth.getUser();
        
        if (authError || !user) {
          window.location.href = 'login.html';
          return;
        }

        // Get profile
        const { data: profile, error: profileError } = await supabase
          .from('profiles')
          .select('id, role, fullname, email')
          .eq('id', user.id)
          .single();

        if (profileError || !profile || profile.role !== 'therapist') {
          alert('Access denied. Therapist role required.');
          window.location.href = 'login.html';
          return;
        }

        // Get therapist details (FIXED: using id, not userid)
        const { data: therapist, error: therapistError } = await supabase
          .from('Therapists')
          .select('*')
          .eq('id', profile.id)
          .single();

        if (therapistError) {
          console.error('Therapist fetch error:', therapistError);
          alert('Error loading therapist profile.');
          window.location.href = 'login.html';
          return;
        }

        // Check approval status
        if (therapist.approvalstatus !== 'approved') {
          await supabase.auth.signOut();
          alert('Your therapist account is pending approval. Please wait for admin approval.');
          window.location.href = 'login.html';
          return;
        }

        currentTherapist = therapist;

        // Update UI
        updateHeader(therapist);
        
        // Load bookings
        await loadBookings();

      } catch (error) {
        console.error('Initialization error:', error);
        alert('Error loading dashboard. Please try again.');
        window.location.href = 'login.html';
      }
    }

    function updateHeader(therapist) {
      const nameEl = document.getElementById('therapistName');
      const specEl = document.getElementById('therapistSpecialization');
      const avatarEl = document.getElementById('therapistAvatar');

      const displayName = therapist.Name ? `Dr. ${therapist.Name}` : 'Therapist Dashboard';
      nameEl.textContent = displayName;
      specEl.textContent = therapist.Specialization || 'General Therapy';
      avatarEl.textContent = (therapist.Name || 'T').charAt(0).toUpperCase();
    }

    async function loadBookings() {
      try {
        const { data: bookings, error } = await supabase
          .from('Bookings')
          .select('*')
          .eq('therapistid', currentTherapist.id)
          .order('sessiondate', { ascending: false });

        if (error) throw error;

        allBookings = bookings || [];

        // Update stats
        updateStats(allBookings);

        // Display bookings
        displayPendingBookings(allBookings.filter(b => b.status === 'pending'));
        displayAllBookings(allBookings);

      } catch (error) {
        console.error('Error loading bookings:', error);
        document.getElementById('pendingBookingsList').innerHTML = '<div class="empty-state"><i class="fas fa-exclamation-circle"></i><p>Error loading bookings</p></div>';
        document.getElementById('allBookingsList').innerHTML = '<div class="empty-state"><i class="fas fa-exclamation-circle"></i><p>Error loading bookings</p></div>';
      }
    }

    function updateStats(bookings) {
      document.getElementById('totalBookings').textContent = bookings.length;
      document.getElementById('pendingBookings').textContent = bookings.filter(b => b.status === 'pending').length;
      document.getElementById('confirmedBookings').textContent = bookings.filter(b => b.status === 'confirmed').length;
      document.getElementById('completedBookings').textContent = bookings.filter(b => b.status === 'completed').length;
    }

    async function displayPendingBookings(bookings) {
      const container = document.getElementById('pendingBookingsList');

      if (!bookings.length) {
        container.innerHTML = '<div class="empty-state"><i class="fas fa-check-circle"></i><p>No pending booking requests</p></div>';
        return;
      }

      // Get user names
      const userIds = [...new Set(bookings.map(b => b.userid))];
      const { data: users } = await supabase
        .from('profiles')
        .select('id, fullname')
        .in('id', userIds);

      container.innerHTML = bookings.map(booking => {
        const user = users?.find(u => u.id === booking.userid);
        const date = new Date(booking.sessiondate).toLocaleDateString('en-IN', { weekday: 'short', day: 'numeric', month: 'short', year: 'numeric' });

        return `
          <div class="booking-row">
            <div>
              <div style="font-weight:700;color:#2C3E50;margin-bottom:6px;">
                <span class="booking-status pending">PENDING</span>
                ${user?.fullname || 'Patient'} â€¢ ${date} â€¢ ${booking.starttime || 'Not set'}
              </div>
              <div style="color:#6B7280;font-size:13px;">
                Booking ID: ${String(booking.id).slice(0, 8)} â€¢ Duration: ${booking.duration || 60} mins â€¢ Amount: â‚¹${booking.amount || 500}
              </div>
              <div class="action-buttons">
                <button class="btn-action btn-approve" onclick="approveBooking('${booking.id}')">
                  <i class="fas fa-check"></i> Accept
                </button>
                <button class="btn-action btn-reject" onclick="rejectBooking('${booking.id}')">
                  <i class="fas fa-times"></i> Decline
                </button>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    async function displayAllBookings(bookings) {
      const container = document.getElementById('allBookingsList');

      if (!bookings.length) {
        container.innerHTML = '<div class="empty-state"><i class="fas fa-calendar-times"></i><p>No bookings yet</p></div>';
        return;
      }

      // Get user names
      const userIds = [...new Set(bookings.map(b => b.userid))];
      const { data: users } = await supabase
        .from('profiles')
        .select('id, fullname')
        .in('id', userIds);

      container.innerHTML = bookings.map(booking => {
        const user = users?.find(u => u.id === booking.userid);
        const date = new Date(booking.sessiondate).toLocaleDateString('en-IN', { weekday: 'short', day: 'numeric', month: 'short', year: 'numeric' });
        const status = booking.status || 'pending';

        return `
          <div class="booking-row">
            <div>
              <div style="font-weight:700;color:#2C3E50;margin-bottom:6px;">
                <span class="booking-status ${status}">${status.toUpperCase()}</span>
                ${user?.fullname || 'Patient'} â€¢ ${date} â€¢ ${booking.starttime || 'Not set'}
              </div>
              <div style="color:#6B7280;font-size:13px;">
                Booking ID: ${String(booking.id).slice(0, 8)} â€¢ Duration: ${booking.duration || 60} mins â€¢ Amount: â‚¹${booking.amount || 500}
              </div>
              ${status === 'confirmed' ? `
                <div class="action-buttons">
                  <button class="btn-action btn-complete" onclick="completeBooking('${booking.id}')">
                    <i class="fas fa-check-double"></i> Mark Complete
                  </button>
                </div>
              ` : ''}
            </div>
          </div>
        `;
      }).join('');
    }

    async function approveBooking(bookingId) {
      if (!confirm('Accept this booking request?')) return;

      try {
        const { error } = await supabase
          .from('Bookings')
          .update({ status: 'confirmed' })
          .eq('id', bookingId);

        if (error) throw error;

        showNotification('Booking accepted successfully!', 'success');
        await loadBookings();
      } catch (error) {
        console.error('Error approving booking:', error);
        showNotification('Error accepting booking', 'error');
      }
    }

    async function rejectBooking(bookingId) {
      const reason = prompt('Reason for declining (optional):');
      if (reason === null) return;

      try {
        const { error } = await supabase
          .from('Bookings')
          .update({ 
            status: 'cancelled',
            cancellationreason: reason || 'Declined by therapist'
          })
          .eq('id', bookingId);

        if (error) throw error;

        showNotification('Booking declined', 'info');
        await loadBookings();
      } catch (error) {
        console.error('Error rejecting booking:', error);
        showNotification('Error declining booking', 'error');
      }
    }

    async function completeBooking(bookingId) {
      if (!confirm('Mark this session as completed?')) return;

      try {
        const { error } = await supabase
          .from('Bookings')
          .update({ status: 'completed' })
          .eq('id', bookingId);

        if (error) throw error;

        showNotification('Session marked as completed!', 'success');
        await loadBookings();
      } catch (error) {
        console.error('Error completing booking:', error);
        showNotification('Error completing session', 'error');
      }
    }

    function showNotification(message, type = 'info') {
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        top: 100px;
        right: 20px;
        padding: 16px 24px;
        background: ${type === 'success' ? '#4caf50' : type === 'error' ? '#f44336' : '#2196f3'};
        color: white;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        z-index: 10000;
        font-weight: 600;
        animation: slideIn 0.3s ease;
      `;
      notification.textContent = message;
      document.body.appendChild(notification);

      setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => notification.remove(), 300);
      }, 3000);
    }

    async function logout() {
      if (!confirm('Are you sure you want to logout?')) return;
      
      await supabase.auth.signOut();
      localStorage.removeItem('user');
      window.location.href = 'login.html';
    }

    document.getElementById('logoutBtn').addEventListener('click', logout);
    document.getElementById('navLogoutBtn').addEventListener('click', logout);

    // Add animation CSS
    const style = document.createElement('style');
    style.textContent = `
      @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
      }
      @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
      }
    `;
    document.head.appendChild(style);

    init();
  </script>
</body>
</html>
