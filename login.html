<!-- Supabase Configuration -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
    // Prevent duplicate declaration
    if (typeof supabase === 'undefined') {
        var supabase;
    }
    
    // Supabase Configuration
    const SUPABASE_URL = 'https://hviqxpfnvjsqbdjfbttm.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh2aXF4cGZudmpzcWJkamZidHRtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg4NDM0NzIsImV4cCI6MjA4NDQxOTQ3Mn0.P3UWgbYx4MLMJktsXjFsAEtsNpTjqPnO31s2Oyy0BFs';
    supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    
    // Application State
    let isLoading = false;
    
    // DOM Elements
    const loginForm = document.getElementById('loginForm');
    const emailInput = document.getElementById('email');
    const passwordInput = document.getElementById('password');
    const passwordToggle = document.getElementById('passwordToggle');
    const loginBtn = document.getElementById('loginBtn');
    const btnText = document.getElementById('btnText');
    const loadingSpinner = document.getElementById('loadingSpinner');
    const rememberMe = document.getElementById('rememberMe');
    const menuToggle = document.getElementById('menuToggle');
    const navLinks = document.getElementById('navLinks');
    
    // Initialize Application
    document.addEventListener('DOMContentLoaded', function() {
        checkExistingSession();
        loadSavedCredentials();
        initEventListeners();
        
        setTimeout(() => {
            document.querySelector('.login-container').style.opacity = '1';
            document.querySelector('.login-container').style.transform = 'translateY(0)';
        }, 300);
    });
    
    // Check Existing Session
    async function checkExistingSession() {
        try {
            const { data, error } = await supabase.auth.getSession();
            
            if (error) {
                console.error('Session check error:', error);
                return;
            }
            
            if (data && data.session) {
                const userId = data.session.user.id;

                const { data: profile, error: profileError } = await supabase
                    .from('profiles')
                    .select('*')
                    .eq('id', userId)
                    .single();

                if (profileError) {
                    console.error('Profile fetch error:', profileError);
                    return;
                }

                const userData = {
                    id: profile.id,
                    email: profile.email,
                    fullname: profile.fullname || profile.full_name || '',
                    role: profile.role,
                    lastLogin: new Date().toISOString()
                };
                localStorage.setItem('user', JSON.stringify(userData));

                redirectBasedOnRole(profile.role);
            }
        } catch (error) {
            console.error('Error checking session:', error);
        }
    }
    
    // Load Saved Credentials
    function loadSavedCredentials() {
        const savedEmail = localStorage.getItem('mindspace_saved_email');
        const savedRemember = localStorage.getItem('mindspace_remember_me');
        
        if (savedEmail && savedRemember === 'true') {
            emailInput.value = savedEmail;
            rememberMe.checked = true;
        }
    }
    
    // Initialize Event Listeners
    function initEventListeners() {
        passwordToggle.addEventListener('click', togglePasswordVisibility);
        loginForm.addEventListener('submit', handleLogin);
        emailInput.addEventListener('blur', validateEmail);
        passwordInput.addEventListener('blur', validatePassword);
        emailInput.addEventListener('input', clearError);
        passwordInput.addEventListener('input', clearError);
        
        if (menuToggle) {
            menuToggle.addEventListener('click', toggleMobileMenu);
        }
        
        document.addEventListener('click', closeMobileMenu);
    }
    
    // Toggle Password Visibility
    function togglePasswordVisibility() {
        const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
        passwordInput.setAttribute('type', type);
        passwordToggle.innerHTML = type === 'password'
            ? '<i class="fas fa-eye"></i>'
            : '<i class="fas fa-eye-slash"></i>';
    }
    
    // Form Validation
    function validateEmail() {
        const email = emailInput.value.trim();
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        
        if (!email) {
            showError(emailInput, 'Email is required');
            return false;
        }
        
        if (!emailRegex.test(email)) {
            showError(emailInput, 'Please enter a valid email address');
            return false;
        }
        
        clearError(emailInput);
        return true;
    }
    
    function validatePassword() {
        const password = passwordInput.value;
        
        if (!password) {
            showError(passwordInput, 'Password is required');
            return false;
        }
        
        if (password.length < 6) {
            showError(passwordInput, 'Password must be at least 6 characters');
            return false;
        }
        
        clearError(passwordInput);
        return true;
    }
    
    // Error Handling
    function showError(input, message) {
        const formGroup = input.closest('.form-group');
        const errorElement = formGroup.querySelector('.error-message');
        
        formGroup.classList.add('error');
        errorElement.textContent = message;
        errorElement.style.display = 'block';
        input.classList.add('error');
    }
    
    function clearError(input) {
        const formGroup = input.closest('.form-group');
        const errorElement = formGroup.querySelector('.error-message');
        
        formGroup.classList.remove('error');
        errorElement.style.display = 'none';
        input.classList.remove('error');
    }
    
    // Handle Login
    async function handleLogin(event) {
        event.preventDefault();
        
        const isEmailValid = validateEmail();
        const isPasswordValid = validatePassword();
        
        if (!isEmailValid || !isPasswordValid) {
            showNotification('Please fix the errors in the form', 'error');
            return;
        }
        
        isLoading = true;
        loginBtn.disabled = true;
        btnText.textContent = 'Signing In...';
        loadingSpinner.style.display = 'block';
        
        const email = emailInput.value.trim();
        const password = passwordInput.value;
        
        try {
            if (rememberMe.checked) {
                localStorage.setItem('mindspace_saved_email', email);
                localStorage.setItem('mindspace_remember_me', 'true');
            } else {
                localStorage.removeItem('mindspace_saved_email');
                localStorage.removeItem('mindspace_remember_me');
            }
            
            const { data: authData, error: authError } = await supabase.auth.signInWithPassword({
                email: email,
                password: password
            });
            
            if (authError) {
                throw authError;
            }
            
            const { data: profile, error: profileError } = await supabase
                .from('profiles')
                .select('*')
                .eq('id', authData.user.id)
                .single();
            
            if (profileError) {
                throw profileError;
            }

            if (profile.role === 'therapist') {
                const { data: therapist, error: therapistError } = await supabase
                    .from('Therapists')
                    .select('approvalstatus')
                    .eq('id', profile.id)
                    .single();
                
                if (therapistError) {
                    throw therapistError;
                }
                
                if (therapist && therapist.approvalstatus !== 'approved') {
                    await supabase.auth.signOut();
                    throw new Error('Your therapist account is pending approval. Please wait for admin approval.');
                }
            }
            
            const userData = {
                id: profile.id,
                email: profile.email,
                fullname: profile.fullname || profile.full_name || '',
                role: profile.role,
                lastLogin: new Date().toISOString()
            };
            
            localStorage.setItem('user', JSON.stringify(userData));
            
            showNotification(`Welcome back, ${userData.fullname || 'User'}!`, 'success');
            
            setTimeout(() => {
                redirectBasedOnRole(profile.role);
            }, 1500);
            
        } catch (error) {
            console.error('Login error:', error);
            
            let errorMessage = 'Login failed. Please try again.';
            
            if (error.message && error.message.includes('Invalid login credentials')) {
                errorMessage = 'Invalid email or password. Please try again.';
            } else if (error.message && error.message.includes('Email not confirmed')) {
                errorMessage = 'Please verify your email address before logging in.';
            } else if (error.message && error.message.includes('pending approval')) {
                errorMessage = error.message;
            }
            
            showNotification(errorMessage, 'error');
            resetFormState();
        }
    }
    
    // Redirect Based on Role
    async function redirectBasedOnRole(role) {
        let redirectUrl = 'index.html';
        
        switch (role) {
            case 'admin':
                redirectUrl = 'admin-dashboard.html';
                break;
            case 'therapist':
                redirectUrl = 'therapist-dashboard.html';
                break;
            case 'user':
                redirectUrl = 'user-dashboard.html';
                break;
            default:
                console.error('Unknown user role:', role);
                return;
        }
        
        setTimeout(() => {
            window.location.href = redirectUrl;
        }, 500);
    }
    
    // Reset Form State
    function resetFormState() {
        isLoading = false;
        loginBtn.disabled = false;
        btnText.textContent = 'Sign In';
        loadingSpinner.style.display = 'none';
    }
    
    // Show Notification
    function showNotification(message, type = 'info') {
        const existingNotification = document.querySelector('.notification');
        if (existingNotification) {
            existingNotification.remove();
        }
        
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.innerHTML = `
            <div class="icon">
                ${type === 'success' ? '✅' : type === 'error' ? '❌' : 'ℹ️'}
            </div>
            <div class="message">${message}</div>
            <button class="close-btn" onclick="this.parentElement.remove()">×</button>
        `;
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
            if (notification.parentNode) {
                notification.remove();
            }
        }, 5000);
    }
    
    // Copy Demo Credentials
    function copyCredentials(email, password) {
        const text = `Email: ${email}\nPassword: ${password}`;
        
        navigator.clipboard.writeText(text).then(() => {
            showNotification('Credentials copied to clipboard!', 'success');
            
            emailInput.value = email;
            passwordInput.value = password;
            rememberMe.checked = true;
            
            validateEmail();
            validatePassword();
        }).catch(err => {
            console.error('Failed to copy: ', err);
            showNotification('Failed to copy credentials', 'error');
        });
    }
    
    // Mobile Menu Functions
    function toggleMobileMenu() {
        navLinks.classList.toggle('active');
        menuToggle.innerHTML = navLinks.classList.contains('active') 
            ? '<i class="fas fa-times"></i>' 
            : '<i class="fas fa-bars"></i>';
    }
    
    function closeMobileMenu(event) {
        if (!navLinks.contains(event.target) && !menuToggle.contains(event.target) && navLinks.classList.contains('active')) {
            navLinks.classList.remove('active');
            menuToggle.innerHTML = '<i class="fas fa-bars"></i>';
        }
    }
    
    document.head.insertAdjacentHTML('beforeend', `
        <style>
            .login-container {
                opacity: 0;
                transform: translateY(20px);
                transition: opacity 0.5s ease, transform 0.5s ease;
            }
            
            .feature-item {
                opacity: 0;
                transform: translateX(-20px);
                transition: opacity 0.5s ease, transform 0.5s ease;
            }
            
            .feature-item:nth-child(1) { transition-delay: 0.1s; }
            .feature-item:nth-child(2) { transition-delay: 0.2s; }
            .feature-item:nth-child(3) { transition-delay: 0.3s; }
            
            .loaded .login-container {
                opacity: 1;
                transform: translateY(0);
            }
            
            .loaded .feature-item {
                opacity: 1;
                transform: translateX(0);
            }
        </style>
    `);
    
    window.addEventListener('load', () => {
        document.body.classList.add('loaded');
    });
</script>
